---
layout: post
title: "Setting up Gitlab CI/CD pt. 2"
categories: blog
author:
- Johannes
meta: "NATHAN, gitlab, git, docker, cicd, devops"
---
In the last post, I left off with a half finished pipeline. Now, I finally got it working.

```yaml .gitlab-ci.yml
stages:
    - compile
    - container-build

jekyll-build:
    stage: compile
    image: jekyll/builder
    tags:
        - docker
    script:
        - cd src/
        - jekyll clean
        - jekyll build
    artifacts:
        paths: 
            - src/_site/
        name: "webroot"

container-build:
    stage: container-build
    tags:
        - docker-builder
    dependencies:
        - jekyll-build
    before_script:
        - unset cd
        - docker info
        - echo "$CI_DEPLOY_USER $CI_DEPLOY_PASSWORD $CI_REGISTRY"
        - docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD $CI_REGISTRY
    script:
        - docker build -t $CI_REGISTRY/johannes/www-jmbfountain-de .
        - docker push $CI_REGISTRY/johannes/www-jmbfountain-de

```

So what did I do to fix this? Basically I read through the docs for login/auth for three hours and then figured out I should use a Deployment-Token called "gitlab-deploy-token", and login using `docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD $CI_REGISTRY`. Now, it's time to do the cd part of CI/CD, deploying the website to Kubernetes. However, to get that part done properly, I'll have to first get my new network running, so there will be no more stuff like this for a while.